## Railway + Supabase + GitHub auto-deploy (main) with safe migrations

### Summary
Set up two Railway services (Next.js frontend + FastAPI backend) deployed automatically on every push to `main`, backed by a new Supabase Postgres database. Add Alembic migrations to the backend and run them automatically on backend startup, plus CI guardrails to catch missing config sync and missing migration files before merge.

---

## Decisions (locked)
- **Deploy trigger:** GitHub Actions on `push` to `main` (deploy only the service that changed).
- **DB migrations:** Run **on backend start** (`alembic upgrade head` before Uvicorn starts).
- **Supabase:** Create a **new** Supabase project (prod) in your org.
- **Email (now):** Use Resend API key + Resend-provided `FROM_EMAIL`, and your Gmail as `REPLY_TO_EMAIL`.

---

## Current repo facts (grounded)
- Frontend: Next.js 15 standalone Docker build in `/Users/sankal/Documents/professional/loku-caters-v2/frontend`.
- Backend: FastAPI + SQLAlchemy + pg8000 in `/Users/sankal/Documents/professional/loku-caters-v2/backend`.
- Tokens already present locally (from earlier checks): `GH_TOKEN`, `SUPABASE_ACCESS_TOKEN`, `RAILWAY_API_TOKEN`.
- Email envs you added locally: `RESEND_API_KEY`, `FROM_EMAIL`, `REPLY_TO_EMAIL`.

---

## Changes to codebase (repo-tracked)

### 1) Backend: add Alembic migrations + “migrate then start”
**Add files**
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/alembic.ini`
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/alembic/env.py`
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/alembic/versions/0001_create_orders.py`
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/entrypoint.sh`

**Update files**
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/requirements.txt`: add `alembic==<pinned>`
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/Dockerfile`:
  - run `entrypoint.sh` as the container command
  - bind to Railway’s port: `--port ${PORT:-8000}`
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/database.py`:
  - expose a helper that returns the effective SQLAlchemy URL (so Alembic and app use identical URL logic)
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/config.py`:
  - add optional `reply_to_email: str | None = None`
  - add `email_enabled: bool = True` (so we can disable in env if needed)
- `/Users/sankal/Documents/professional/loku-caters-v2/backend/services/email.py`:
  - set `reply_to` in the Resend request if `reply_to_email` is set
  - no behavior change on failures (keep try/except in the route)

**Migration contents (initial)**
- Create table `orders` matching the existing SQLAlchemy model *without relying on Supabase extensions*:
  - `id TEXT PRIMARY KEY` (UUID string generated by app code)
  - other columns as in `models.py`
  - `created_at TIMESTAMPTZ` default now
  - `total_price DECIMAL(10,2)`
- This avoids any “enable pgcrypto” dependency and is data-safe.

**Startup behavior**
- `entrypoint.sh` does:
  1) `alembic upgrade head`
  2) `uvicorn main:app --host 0.0.0.0 --port ${PORT:-8000}`
- If migration fails, the new backend deploy fails to start (Railway keeps the previous healthy deployment available).

---

### 2) Frontend: make env wiring unambiguous
**Update**
- `/Users/sankal/Documents/professional/loku-caters-v2/frontend/Dockerfile`:
  - keep only what’s actually used at runtime/build time: `NEXT_PUBLIC_API_URL`
  - remove unused build args (`NEXT_PUBLIC_EVENT_DATE`, `NEXT_PUBLIC_PRICE_PER_ITEM`, `NEXT_PUBLIC_CURRENCY`) to prevent drift/confusion.

**No app code change needed**
- Frontend already reads `process.env.NEXT_PUBLIC_API_URL` in `/Users/sankal/Documents/professional/loku-caters-v2/frontend/src/config/event.ts`.

---

### 3) Repo tooling: config-sync guardrails
**Add scripts**
- `/Users/sankal/Documents/professional/loku-caters-v2/scripts/check-config-sync.sh`
  - verifies `config/event-config.json` exactly matches:
    - `frontend/src/config/event-config.json`
    - `backend/event-config.json`
  - fails with a clear message if drift exists.

**Add ignore**
- `/Users/sankal/Documents/professional/loku-caters-v2/.gitignore`: add `.railway/` so CLI linking artifacts never get committed.

---

### 4) GitHub Actions: PR checks + main deploy
**Add workflows**
- `/Users/sankal/Documents/professional/loku-caters-v2/.github/workflows/ci.yml` (on `pull_request`):
  - run `scripts/check-config-sync.sh`
  - migration guardrail: if `backend/models.py` changed, require at least one change under `backend/alembic/versions/`

- `/Users/sankal/Documents/professional/loku-caters-v2/.github/workflows/deploy.yml` (on `push` to `main`):
  - path filter:
    - backend deploy if `backend/**` or `config/**` changed
    - frontend deploy if `frontend/**` or `config/**` changed
  - deploy command uses Railway CLI via `npx`:
    - backend: `npx -y @railway/cli up --ci --detach --path-as-root -p $RAILWAY_PROJECT_ID -s loku-caters-backend backend`
    - frontend: `npx -y @railway/cli up --ci --detach --path-as-root -p $RAILWAY_PROJECT_ID -s loku-caters-frontend frontend`
  - concurrency: cancel in-progress deploys on new pushes to `main`

**GitHub repo secrets required**
- `RAILWAY_API_TOKEN`
- `RAILWAY_PROJECT_ID`

(Optional but recommended for smoke checks)
- `BACKEND_HEALTHCHECK_URL` (e.g. `https://<backend-domain>/api/health`)
- `FRONTEND_URL` (e.g. `https://<frontend-domain>`)

---

## Infrastructure bootstrap (uses your existing root tokens)

### A) Supabase: create new project (Management API)
Using `SUPABASE_ACCESS_TOKEN`:
1) `GET https://api.supabase.com/v1/organizations` → confirm org slug/id
2) `POST https://api.supabase.com/v1/projects` with:
   - `organization_slug`: your org slug (from step 1)
   - `name`: `loku-caters-prod`
   - `db_pass`: auto-generated strong password
   - region selection: choose recommended `us-east-1` (from the “available regions” endpoint you already have access to)
3) Poll `GET /v1/projects/{ref}` until status is ready.
4) Construct backend `DATABASE_URL` from Supabase "Connect > Session pooler" as:
   - `postgresql://postgres.<ref>:<db_pass>@aws-0-<region>.pooler.supabase.com:5432/postgres`
   - Do not use `db.<ref>.supabase.co:5432` on Railway. That direct endpoint is IPv6 and Railway outbound networking is IPv4-only.

### B) Railway: create project + two services + domains + vars
Using `RAILWAY_API_TOKEN` (via `npx @railway/cli`):
1) Create Railway project: `railway init --name "loku-caters-v2" --json`
2) Add services:
   - `railway add --service loku-caters-backend`
   - `railway add --service loku-caters-frontend`
3) Generate Railway-provided domains (1 each):
   - `railway domain --service loku-caters-backend --port 8000 --json`
   - `railway domain --service loku-caters-frontend --port 3000 --json`
4) Set Railway variables (skip deploy triggers while setting):
   - Backend service vars:
     - `DATABASE_URL` (Supabase URL from above)
     - `RESEND_API_KEY`
     - `FROM_EMAIL` (Resend sender you configured)
     - `REPLY_TO_EMAIL` (your Gmail)
     - `FRONTEND_URL` (Railway frontend domain)
   - Frontend service vars:
     - `NEXT_PUBLIC_API_URL` = Railway backend domain (no trailing slash)

### C) GitHub: set required Actions secrets
Using `GH_TOKEN`:
- Create/update repo secrets:
  - `RAILWAY_API_TOKEN`
  - `RAILWAY_PROJECT_ID`
  - (optional) `BACKEND_HEALTHCHECK_URL`, `FRONTEND_URL`
This is done via GitHub’s Actions Secrets API (fetch repo public key, encrypt values, PUT secret).

---

## Email enablement (production-ready without your own domain yet)
- Keep using Resend with:
  - `RESEND_API_KEY` from Resend dashboard
  - `FROM_EMAIL` as a Resend-allowed sender (their test/onboarding sender)
  - `REPLY_TO_EMAIL` = your Gmail (so customers can reply to you immediately)
- Later, when you buy/verify a domain in Resend, switch `FROM_EMAIL` to something like `orders@<your-domain>` with no code changes.

---

## Tests / acceptance criteria
1) **CI (PR):**
   - Fails if config copies drift from `/config/event-config.json`
   - Fails if `backend/models.py` changes without a new Alembic migration

2) **Deploy (main push):**
   - Push a backend-only change → only backend redeploys
   - Push a frontend-only change → only frontend redeploys
   - Push `config/event-config.json` change → both redeploy

3) **Runtime checks (post-deploy):**
   - `GET /api/health` returns OK on backend domain
   - Placing an order:
     - row is inserted into Supabase `orders`
     - Resend email is sent (or if Resend rejects sender, the order still succeeds and backend logs the email failure)

4) **Migrations:**
   - On first deploy, table is created by Alembic
   - On later schema changes, new migration is applied automatically without dropping data

---

## Assumptions / defaults
- Supabase region: `us-east-1` (recommended for NA).
- One environment only: production (no staging unless requested).
- Railway service names:
  - `loku-caters-backend`
  - `loku-caters-frontend`
- DB password is auto-generated and never printed; stored only in Railway `DATABASE_URL`.
